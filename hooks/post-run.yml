---
- name: Find the result file
  find:
    paths: './ansible-testrunner/junit'
    recurse: yes
  register: junit_file
  delegate_to: testrunner

- name: Fetch Junit results
  fetch:
    src: '{{ junit_file.files[0]["path"] }}'
    dest: "{{ lookup('env', 'PWD') }}/junit.xml"
    flat: yes
  delegate_to: testrunner

- name: Cleanup the directories
  file:
    path: './ansible-testrunner/junit'
    state: absent
  delegate_to: testrunner

- include: patches/dci-control-server-issue-40.yml

- name: Upload the results
  dci_file:
    job_id: '{{ job_id }}'
    path: 'junit.xml'
    mime: 'application/junit'
    name: 'run_{{ platform }}_integration_tests'

- name: Remove the junit file
  file:
    path: 'junit.xml'
    state: absent

- name: Explicitly fails if the test suite has a failure
  fail:
    msg: 'The integration test suite exited with failures. Please check the log'
  when: integration_tests_suite.rc != 0
