---
- name: Find the JUnit result files
  find:
    paths: './ansible-testrunner/ansible/test/results/junit/'
    # Incase there are multiple platforms being tested, only copy the one we are interestd in
    patterns: '{{ platform }}_*.xml'
    recurse: yes
  register: junit_files
  delegate_to: testrunner

- name: Create temp directory
  file:
    path: "{{ lookup('env', 'PWD') }}/junit-{{ job_id }}"
    state: directory

- name: Fetch JUnit results
  fetch:
    src: '{{ item.path }}'
    dest: "{{ lookup('env', 'PWD') }}/junit-{{ job_id }}"
    flat: yes
    validate_checksum: no
  with_items: '{{ junit_files.files }}'
  delegate_to: testrunner

- name: Combine JUnit results into single file
  shell: "xunitmerge {{ lookup('env', 'PWD') }}/junit-{{ job_id }}/*.xml {{ lookup('env', 'PWD') }}/junit-{{ job_id }}.xml"

- name: Upload the results to DCI
  dci_file:
    job_id: '{{ job_id }}'
    path: "{{ lookup('env', 'PWD') }}/junit-{{ job_id }}.xml"
    mime: 'application/junit'
    name: 'run_{{ platform }}_integration_tests'

- name: Delete JUnit files
  file:
    path: "{{ item }}"
    state: absent
  with_items:
    - "{{ lookup('env', 'PWD') }}/junit-{{ job_id }}.xml"
    - "{{ lookup('env', 'PWD') }}/junit-{{ job_id }}"

- name: Explicitly fails if the test suite has a failure
  fail:
    msg: 'The integration test suite exited with failures. Please check the log'
  when: integration_tests_suite.rc != 0
